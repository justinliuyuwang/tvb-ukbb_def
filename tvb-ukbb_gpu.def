Bootstrap: library
From: ubuntu:18.04

%post
    echo "ASDASDASD"
    apt update -y
    apt install -y --no-install-recommends software-properties-common
    add-apt-repository -y universe

    add-apt-repository -y ppa:ubuntu-toolchain-r/test
    apt update -y
    apt upgrade -y
    # apt install -y gcc-9


    apt update && apt install -y --no-install-recommends \
    lsb-core bsdtar zip unzip gzip curl jq wget python-pip bc dc strace \
    software-properties-common xvfb tcsh ca-certificates

    # apt build-dep mesa
    add-apt-repository ppa:graphics-drivers/ppa
    apt update

    
    DEBIAN_FRONTEND=noninteractive apt -y install libgl1-mesa-dev libgl1-mesa-dri libglu1-mesa-dev freeglut3-dev mesa-common-dev \
    tclsh wish openjdk-8-jdk libx11-dev xorg-dev libglew1.5-dev libgl1-mesa-glx \
    mesa-utils freeglut3 libglw1-mesa libglw1-mesa-dev \
    xauth xorg openbox xserver-xorg libvte-common libvte-dev \
    libgomp1 libice6 libopenblas-base libxcursor1 libxft2 libxinerama1 libxrandr2 \
    libxrender1 libxt6 libfontconfig1 libfreetype6 freeglut3 libgtk-3-0 libgtk-3-dev \
    libsdl1.2-dev libsdl1.2debian libsm6 gstreamer1.0-plugins-base \
    ninja-build libosmesa6 libosmesa6-dev


    # vim8 because the creator of this image is a vim user
    add-apt-repository ppa:jonathonf/vim
    apt update -y
    apt install -y vim

    apt clean

    mkdir -p /opt/convert3d
    curl -fsSL https://sourceforge.net/projects/c3d/files/c3d/Nightly/c3d-nightly-Linux-x86_64.tar.gz/download \
    | tar -xz -C /opt/convert3d --strip-components 1

    export PATH="/opt/convert3d/bin:$PATH"


    apt install -y --no-install-recommends r-base r-cran-devtools \
    libblas-dev liblapack-dev gfortran r-cran-catools r-cran-gplots g++ && \
    Rscript -e 'require(devtools); install_version("kernlab", version="0.9-24")' && \
    Rscript -e 'require(devtools); install_version("ROCR", version="1.0-7")' && \
    Rscript -e 'require(devtools); install_version("class", version="7.3-14")' && \
    Rscript -e 'require(devtools); install_version("mvtnorm", version="1.0-8")' && \
    Rscript -e 'require(devtools); install_version("multcomp", version="1.4-8")' && \
    Rscript -e 'require(devtools); install_version("coin", version="1.2-2")' && \
    Rscript -e 'require(devtools); install_version("party", version="1.0-25")' && \
    Rscript -e 'require(devtools); install_version("e1071", version="1.6-7")' && \
    Rscript -e 'require(devtools); install_version("randomForest", version="4.6-12")'

    # install conda
    curl https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -o mc.sh
    bash mc.sh -bfp /opt/miniconda3
    rm -f mc.sh

    __conda_setup="$('/opt/miniconda3/bin/conda' 'shell.bash' 'hook' 2> /dev/null)"
    if [ $? -eq 0 ]; then
        eval "$__conda_setup"
    else
        if [ -f "/opt/miniconda3/etc/profile.d/conda.sh" ]; then
            . "/opt/miniconda3/etc/profile.d/conda.sh"
        else
            export PATH="/opt/miniconda3/bin:$PATH"
        fi
    fi
    unset __conda_setup

    echo ". /opt/miniconda3/etc/profile.d/conda.sh" >> $SINGULARITY_ENVIRONMENT    
    /opt/miniconda3/bin/conda init bash
    eval $(conda shell.bash hook)

    yes | conda update conda
    conda install -y -c numba cudatoolkit=10.2

    export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/opt/miniconda3/lib"

    # just so we have them
    conda install -y -c conda-forge vim git



    # extract and install TVB-UKBB pipeline
    cd /opt
    #wget https://github.com/McIntosh-Lab-RRI/tvb-ukbb/releases/download/1.3/tvb-pipeline_installer_1.3.zip
    mkdir tvb-pipeline
    cd /opt/tvb-pipeline
    wget https://github.com/justinliuyuwang/tvb-ukbb_def/raw/refs/heads/main/tvb-pipeline.zip
    #https://github.com/yilewang/tvbdemos/raw/master/container/tvb-pipeline.zip
    unzip tvb-pipeline.zip
    rm -f tvb-pipeline.zip

    # mv ../tvb-ukbb .
    # yes | ./install_ukbb_norepo.sh
    yes | ./install_ukbb_singularity.sh

    conda clean -y --all
    # conda deactivate

    mkdir /opt/mcr && mkdir /mcr-install && cd /mcr-install && \
    wget https://ssd.mathworks.com/supportfiles/downloads/R2017b/deployment_files/R2017b/installers/glnxa64/MCR_R2017b_glnxa64_installer.zip && \
    unzip MCR_R2017b_glnxa64_installer.zip && \
    rm -rf MCR_R2017b_glnxa64_installer.zip && \
    ./install -destinationFolder /opt/mcr -agreeToLicense yes -mode silent && \
    cd / && rm -rf mcr-install

    export FSL_FIX_MCRROOT=/opt/mcr



    # install FSL and configure CUDA
   # wget https://git.fmrib.ox.ac.uk/fsl/installer/-/raw/3.3.0/fslinstaller.py  #https://fsl.fmrib.ox.ac.uk/fsldownloads/fslinstaller.py
    # 6.0.4
    wget https://fsl.fmrib.ox.ac.uk/fsldownloads/fslinstaller.py
    #python fslinstaller.py -V 6.0.6 -d /opt/fsl
    python2 fslinstaller.py -V 6.0.6 -d /opt/fsl
    echo '/opt/fsl/lib' > /etc/ld.so.conf.d/fsl.conf
    ldconfig
    echo "HELLO I AM HERE"
    cd /opt/fsl/bin && ln -sf eddy_cuda10.2 eddy_cuda

    export FSLDIR=/opt/fsl
    export FSL_DIR="${FSLDIR}"
    export FSLOUTPUTTYPE=NIFTI_GZ
    export PATH=/opt/fsl:$PATH
    export FSLMULTIFILEQUIT=TRUE
    export POSSUMDIR=/opt/fsl/bi
    export LD_LIBRARY_PATH=/opt/fsl/lib:$LD_LIBRARY_PATH
    export FSLTCLSH=/usr/bin/tclsh
    export FSLWISH=/usr/bin/wish

    # clean up a bit
    rm -f fslinstaller.py

    # symlink env so executable python scripts can find the
    # python installation on the PATH
    ln -s /usr/bin/env /bin/env

    # make /bin/sh point to bash instead
    echo "dash dash/sh boolean false" | debconf-set-selections
    # TESTING
    # DEBIAN_FRONTEND=noninteractive dpkg-reconfigure dash
    ln -sf /bin/bash /bin/sh

    export LD_LIBRARY_PATH="/usr/lib:$LD_LIBRARY_PATH"
    export LD_LIBRARY_PATH="/opt/miniconda3/lib:$LD_LIBRARY_PATH"
    export PATH="/opt/convert3d/bin:$PATH"
    
    export LIBGL_ALWAYS_INDIRECT=0
    export QT_X11_NO_MITSHM=1

%environment

    __conda_setup="$('/opt/miniconda3/bin/conda' 'shell.bash' 'hook' 2> /dev/null)"
    if [ $? -eq 0 ]; then
        eval "$__conda_setup"
    else
        if [ -f "/opt/miniconda3/etc/profile.d/conda.sh" ]; then
            . "/opt/miniconda3/etc/profile.d/conda.sh"
        else
            export PATH="/opt/miniconda3/bin:$PATH"
            export LD_LIBRARY_PATH="/opt/miniconda3/lib:$LD_LIBRARY_PATH"
        fi
    fi
    unset __conda_setup

    export FSLDIR=/opt/fsl
    . $FSLDIR/etc/fslconf/fsl.sh
    export PATH=$FSLDIR/bin/:$PATH

    export LD_LIBRARY_PATH="/usr/lib:$LD_LIBRARY_PATH"
    export LD_LIBRARY_PATH="/opt/miniconda3/lib:$LD_LIBRARY_PATH"
    export PATH="/opt/convert3d/bin:$PATH"
    export LIBGL_ALWAYS_INDIRECT=0
    export QT_X11_NO_MITSHM=1

    # my favourite alias
    alias lr='ls -haltr'

%runscript

    echo "Container created ${NOW}"

    GITDIR=${2}
    echo "Git directory specified: ${GITDIR}"
    export BB_BIN_DIR=${GITDIR}
    . ${GITDIR}/init_vars
    echo "Subject directory: ${1}"
    echo "Running..."
    exec python -u ${GITDIR}/bb_pipeline_tools/bb_pipeline.py ${1} 


    

%labels
    Author nfrazier-logue@research.baycrest.org
    Version v1.0

%help
    This is a TVB-UKBB container installed with FSL 6.0.4 and CUDA 9.1.
    It provides all necessary software, with the exeption of AFNI, ANTS,
    and FreeSurfer, to run the TVB-UKBB pipeline.
vboxuser@ubuntuu:~$ cp old_all_yileinstaller_102.def 1_ub1804_yiletvbwjustincondafix_yilematlab_cuda102.def
vboxuser@ubuntuu:~$ ls -lt
total 62527968
-rw-rw-r--  1 vboxuser vboxuser      328752 Jan  4 21:51 yile_again.txt
-rw-rw-r--  1 vboxuser vboxuser        7330 Jan  4 21:49 1_ub1804_yiletvbwjustincondafix_yilematlab_cuda102.def
-rw-rw-r--  1 vboxuser vboxuser        8045 Jan  4 21:47 yile_gpu.def
-rw-rw-r--  1 vboxuser vboxuser        7330 Jan  4 21:46 old_all_yileinstaller_102.def
drwxr-xr-x  2 vboxuser vboxuser        4096 Jan  4 20:36 Downloads
-rw-rw-r--  1 vboxuser vboxuser     3144573 Jan  4 20:20 yile.txt
-rwxr-xr-x  1 vboxuser vboxuser  8981557248 Jan  4 20:20 yile_gpu.sif
-rw-rw-r--  1 vboxuser vboxuser     3073795 Jan  4 20:10 buildlog_old_102_yileinstaller.txt
-rwxr-xr-x  1 vboxuser vboxuser  8974958592 Jan  4 20:10 old_102_yileinstaller.sif
-rw-rw-r--  1 vboxuser vboxuser     3065932 Jan  4 19:18 buildlog_old_102.txt
-rwxr-xr-x  1 vboxuser vboxuser  8387706880 Jan  4 19:18 old_102.sif
-rw-rw-r--  1 vboxuser vboxuser        7163 Jan  4 18:41 old_all_102.def
-rw-rw-r--  1 vboxuser vboxuser        7162 Jan  4 18:39 def_old.def
-rw-rw-r--  1 vboxuser vboxuser     3159178 Jan  3 22:58 buildlog.txt
-rwxr-xr-x  1 vboxuser vboxuser  8981528576 Jan  3 22:58 yile_gpu_new.sif
-rwxr-xr-x  1 vboxuser vboxuser    27746304 Jan  3 20:23 lib.sif
-rw-rw-r--  1 vboxuser vboxuser          40 Jan  3 20:22 test.def
-rwxrwxr-x  1 vboxuser vboxuser    27756293 Jan  3 20:12 ubuntu_20.04.sif
-rwxrwxr-x  1 vboxuser vboxuser    25892613 Jan  3 20:11 ubuntu_18.04.sif
-rwxr-xr-x  1 vboxuser vboxuser 10399948800 Jan  3 05:49 fixed_old_fsl.sif
-rw-rw-r--  1 vboxuser vboxuser     8328825 Jan  3 05:40 def_old_build.log
-rw-rw-r--  1 vboxuser vboxuser        6868 Jan  3 04:50 old_bug.def
-rwxr-xr-x  1 vboxuser vboxuser  8181145600 Jan  1 18:12 ok.sif
-rw-rw-r--  1 vboxuser vboxuser         159 Dec 31 23:58 build.log
-rwxr-x---  1 vboxuser vboxuser 10014119454 Dec 31 23:42 tvb-ukbb_gpu.sif
drwxrwxr-x 33 vboxuser vboxuser        4096 Dec 31 22:43 fsl
drwxrwxr-x  3 vboxuser vboxuser        4096 Dec 16 08:20 fsl-102523-1734337215.208936
-rw-r-----  1 vboxuser vboxuser     3819159 Dec 15 05:48 data_B0.nii.gz
-rw-r-----  1 vboxuser vboxuser      972967 Dec 14 22:59 T1_brain_pve_1.nii.gz
-rw-r-----  1 vboxuser vboxuser      201542 Dec 14 22:58 parcel_to_T1_TVBSchaeferTian220.nii.gz
drwx------  5 vboxuser vboxuser        4096 Dec 14 21:00 snap
drwxr-xr-x  3 vboxuser vboxuser        4096 Dec 14 20:59 Documents
drwxr-xr-x  2 vboxuser vboxuser        4096 Dec 14 20:36 Desktop
drwxr-xr-x  2 vboxuser vboxuser        4096 Dec 14 20:36 Music
drwxr-xr-x  2 vboxuser vboxuser        4096 Dec 14 20:36 Pictures
drwxr-xr-x  2 vboxuser vboxuser        4096 Dec 14 20:36 Public
drwxr-xr-x  2 vboxuser vboxuser        4096 Dec 14 20:36 Templates
drwxr-xr-x  2 vboxuser vboxuser        4096 Dec 14 20:36 Videos
vboxuser@ubuntuu:~$ cat 1_ub1804_yiletvbwjustincondafix_yilematlab_cuda102.def
Bootstrap: library
From: ubuntu:18.04

%post
    echo "ASDASDASD"
    apt update -y
    apt install -y --no-install-recommends software-properties-common
    add-apt-repository -y universe

    add-apt-repository -y ppa:ubuntu-toolchain-r/test
    apt update -y
    apt upgrade -y
    # apt install -y gcc-9


    apt update && apt install -y --no-install-recommends \
    lsb-core bsdtar zip unzip gzip curl jq wget python-pip bc dc strace \
    software-properties-common xvfb tcsh ca-certificates

    # apt build-dep mesa
    add-apt-repository ppa:graphics-drivers/ppa
    apt update

    
    DEBIAN_FRONTEND=noninteractive apt -y install libgl1-mesa-dev libgl1-mesa-dri libglu1-mesa-dev freeglut3-dev mesa-common-dev \
    tclsh wish openjdk-8-jdk libx11-dev xorg-dev libglew1.5-dev libgl1-mesa-glx \
    mesa-utils freeglut3 libglw1-mesa libglw1-mesa-dev \
    xauth xorg openbox xserver-xorg libvte-common libvte-dev \
    libgomp1 libice6 libopenblas-base libxcursor1 libxft2 libxinerama1 libxrandr2 \
    libxrender1 libxt6 libfontconfig1 libfreetype6 freeglut3 libgtk-3-0 libgtk-3-dev \
    libsdl1.2-dev libsdl1.2debian libsm6 gstreamer1.0-plugins-base \
    ninja-build libosmesa6 libosmesa6-dev


    # vim8 because the creator of this image is a vim user
    add-apt-repository ppa:jonathonf/vim
    apt update -y
    apt install -y vim

    apt clean

    mkdir -p /opt/convert3d
    curl -fsSL https://sourceforge.net/projects/c3d/files/c3d/Nightly/c3d-nightly-Linux-x86_64.tar.gz/download \
    | tar -xz -C /opt/convert3d --strip-components 1

    export PATH="/opt/convert3d/bin:$PATH"


    apt install -y --no-install-recommends r-base r-cran-devtools \
    libblas-dev liblapack-dev gfortran r-cran-catools r-cran-gplots g++ && \
    Rscript -e 'require(devtools); install_version("kernlab", version="0.9-24")' && \
    Rscript -e 'require(devtools); install_version("ROCR", version="1.0-7")' && \
    Rscript -e 'require(devtools); install_version("class", version="7.3-14")' && \
    Rscript -e 'require(devtools); install_version("mvtnorm", version="1.0-8")' && \
    Rscript -e 'require(devtools); install_version("multcomp", version="1.4-8")' && \
    Rscript -e 'require(devtools); install_version("coin", version="1.2-2")' && \
    Rscript -e 'require(devtools); install_version("party", version="1.0-25")' && \
    Rscript -e 'require(devtools); install_version("e1071", version="1.6-7")' && \
    Rscript -e 'require(devtools); install_version("randomForest", version="4.6-12")'

    # install conda
    curl https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -o mc.sh
    bash mc.sh -bfp /opt/miniconda3
    rm -f mc.sh

    __conda_setup="$('/opt/miniconda3/bin/conda' 'shell.bash' 'hook' 2> /dev/null)"
    if [ $? -eq 0 ]; then
        eval "$__conda_setup"
    else
        if [ -f "/opt/miniconda3/etc/profile.d/conda.sh" ]; then
            . "/opt/miniconda3/etc/profile.d/conda.sh"
        else
            export PATH="/opt/miniconda3/bin:$PATH"
        fi
    fi
    unset __conda_setup

    echo ". /opt/miniconda3/etc/profile.d/conda.sh" >> $SINGULARITY_ENVIRONMENT    
    /opt/miniconda3/bin/conda init bash
    eval $(conda shell.bash hook)

    yes | conda update conda
    conda install -y -c numba cudatoolkit=10.2

    export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/opt/miniconda3/lib"

    # just so we have them
    conda install -y -c conda-forge vim git



    # extract and install TVB-UKBB pipeline
    cd /opt
    #wget https://github.com/McIntosh-Lab-RRI/tvb-ukbb/releases/download/1.3/tvb-pipeline_installer_1.3.zip
    mkdir tvb-pipeline
    cd /opt/tvb-pipeline
    wget https://github.com/justinliuyuwang/tvb-ukbb_def/raw/refs/heads/main/tvb-pipeline.zip
    #https://github.com/yilewang/tvbdemos/raw/master/container/tvb-pipeline.zip
    unzip tvb-pipeline.zip
    rm -f tvb-pipeline.zip

    # mv ../tvb-ukbb .
    # yes | ./install_ukbb_norepo.sh
    yes | ./install_ukbb_singularity.sh

    conda clean -y --all
    # conda deactivate

    mkdir /opt/mcr && mkdir /mcr-install && cd /mcr-install && \
    wget https://ssd.mathworks.com/supportfiles/downloads/R2017b/deployment_files/R2017b/installers/glnxa64/MCR_R2017b_glnxa64_installer.zip && \
    unzip MCR_R2017b_glnxa64_installer.zip && \
    rm -rf MCR_R2017b_glnxa64_installer.zip && \
    ./install -destinationFolder /opt/mcr -agreeToLicense yes -mode silent && \
    cd / && rm -rf mcr-install

    export FSL_FIX_MCRROOT=/opt/mcr



    # install FSL and configure CUDA
   # wget https://git.fmrib.ox.ac.uk/fsl/installer/-/raw/3.3.0/fslinstaller.py  #https://fsl.fmrib.ox.ac.uk/fsldownloads/fslinstaller.py
    # 6.0.4
    wget https://fsl.fmrib.ox.ac.uk/fsldownloads/fslinstaller.py
    #python fslinstaller.py -V 6.0.6 -d /opt/fsl
    python2 fslinstaller.py -V 6.0.6 -d /opt/fsl
    echo '/opt/fsl/lib' > /etc/ld.so.conf.d/fsl.conf
    ldconfig
    echo "HELLO I AM HERE"
    cd /opt/fsl/bin && ln -sf eddy_cuda10.2 eddy_cuda

    export FSLDIR=/opt/fsl
    export FSL_DIR="${FSLDIR}"
    export FSLOUTPUTTYPE=NIFTI_GZ
    export PATH=/opt/fsl:$PATH
    export FSLMULTIFILEQUIT=TRUE
    export POSSUMDIR=/opt/fsl/bi
    export LD_LIBRARY_PATH=/opt/fsl/lib:$LD_LIBRARY_PATH
    export FSLTCLSH=/usr/bin/tclsh
    export FSLWISH=/usr/bin/wish

    # clean up a bit
    rm -f fslinstaller.py

    # symlink env so executable python scripts can find the
    # python installation on the PATH
    ln -s /usr/bin/env /bin/env

    # make /bin/sh point to bash instead
    echo "dash dash/sh boolean false" | debconf-set-selections
    # TESTING
    # DEBIAN_FRONTEND=noninteractive dpkg-reconfigure dash
    ln -sf /bin/bash /bin/sh

    export LD_LIBRARY_PATH="/usr/lib:$LD_LIBRARY_PATH"
    export LD_LIBRARY_PATH="/opt/miniconda3/lib:$LD_LIBRARY_PATH"
    export PATH="/opt/convert3d/bin:$PATH"
    
    export LIBGL_ALWAYS_INDIRECT=0
    export QT_X11_NO_MITSHM=1

%environment

    __conda_setup="$('/opt/miniconda3/bin/conda' 'shell.bash' 'hook' 2> /dev/null)"
    if [ $? -eq 0 ]; then
        eval "$__conda_setup"
    else
        if [ -f "/opt/miniconda3/etc/profile.d/conda.sh" ]; then
            . "/opt/miniconda3/etc/profile.d/conda.sh"
        else
            export PATH="/opt/miniconda3/bin:$PATH"
            export LD_LIBRARY_PATH="/opt/miniconda3/lib:$LD_LIBRARY_PATH"
        fi
    fi
    unset __conda_setup

    export FSLDIR=/opt/fsl
    . $FSLDIR/etc/fslconf/fsl.sh
    export PATH=$FSLDIR/bin/:$PATH

    export LD_LIBRARY_PATH="/usr/lib:$LD_LIBRARY_PATH"
    export LD_LIBRARY_PATH="/opt/miniconda3/lib:$LD_LIBRARY_PATH"
    export PATH="/opt/convert3d/bin:$PATH"
    export LIBGL_ALWAYS_INDIRECT=0
    export QT_X11_NO_MITSHM=1

    # my favourite alias
    alias lr='ls -haltr'

%runscript

    echo "Container created ${NOW}"

    GITDIR=${2}
    echo "Git directory specified: ${GITDIR}"
    export BB_BIN_DIR=${GITDIR}
    . ${GITDIR}/init_vars
    echo "Subject directory: ${1}"
    echo "Running..."
    exec python -u ${GITDIR}/bb_pipeline_tools/bb_pipeline.py ${1} 


    

%labels
    Author nfrazier-logue@research.baycrest.org
    Version v1.0

%help
    This is a TVB-UKBB container installed with FSL 6.0.4 and CUDA 9.1.
    It provides all necessary software, with the exeption of AFNI, ANTS,
    and FreeSurfer, to run the TVB-UKBB pipeline.
